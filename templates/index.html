<!DOCTYPE html>
<html>
<head>
    <title>Tic Tac Toe</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.3.2/socket.io.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="container">
        <h1>Tic Tac Toe Game</h1>
        <div class="game">
            <div id="credits-box">
                <span id="credits-text">Credits: </span>
                <span id="credits-amount"></span>
            </div>
            <div class="controls">
            <button id="start-btn">Start Game</button>
            <button id="again-btn">Play Again</button>
            <button id="add-credits-btn">Add Credits</button>
            </div>
            <div id="board">
                <div class="row">
                    <div class="box top left" data-id="0"></div>
                    <div class="box top" data-id="1"></div>
                    <div class="box top right" data-id="2"></div>
                </div>
                <div class="row">
                    <div class="box left" data-id="3"></div>
                    <div class="box" data-id="4"></div>
                    <div class="box right" data-id="5"></div>
                </div>
                <div class="row">
                    <div class="box bottom left" data-id="6"></div>
                    <div class="box bottom" data-id="7"></div>
                    <div class="box bottom right" data-id="8"></div>
                </div>
            </div>
            <div id="turn-box">
                <span id="turn-text">Turn: </span>
                <span id="turn"></span>
            </div>
            <div id="message"></div>
        </div>
    </div>
    <script>
        const socket = io.connect();

        let credits;
        let turn;

        const gameBoard = document.getElementById('board');
        const boxes = document.getElementsByClassName('box');
        const creditsBox = document.getElementById('credits-box');
        const turnBox = document.getElementById('turn-box');
        const startGameButton = document.getElementById('start-btn');
        const playAgainButton = document.getElementById('again-btn');
        const addCreditsButton = document.getElementById('add-credits-btn');

        const updateText = (field, value) => {
            document.getElementById(field).textContent = value;
        };

        const updateBoard = (data) => {
            for (var i = 0; i < data.board.length; i++) {
                boxes[i].textContent = data.board[i];
            }
        };

        const updateSessionState = (data) => {
            if (data.message) {
                updateText('message', data.message);
            };
            if (data.credits) {
                updateText('credits-amount', data.credits);
            };
            if (data.board) {
                updateBoard(data);
            };
        };

        const showElement = (element) => {
            element.style.display = 'block';
        };

        const hideElement = (element) => {
            element.style.display = 'none';
        };


        socket.on('connected', function(data) {
            updateSessionState(data);
            showElement(creditsBox);
        });

        socket.on('game_started', function(data) {
            hideElement(startGameButton);
            updateSessionState(data);
            showElement(gameBoard);
        });

        socket.on('playing_again', function(data) {
            hideElement(playAgainButton);
            hideElement(addCreditsButton);
            updateSessionState(data);
        });

        socket.on('game_ended', function(data) {
            updateSessionState(data);
            showElement(playAgainButton);
            showElement(addCreditsButton);
        });

        socket.on('state_updated', function(data) {
            updateSessionState(data);
            unlockCells();
        });

        socket.on('state_updated_no_unlock', function(data) {
            updateSessionState(data);
        });

        startGameButton.addEventListener('click', function() {
            lockCells();
            socket.emit('start_game');
        });

        playAgainButton.addEventListener('click', function() {
            lockCells();
            socket.emit('play_again');
        });

        addCreditsButton.addEventListener('click', function() {
            socket.emit('add_credits');
        });


        const lockCells = function() {
            for (box of boxes)
            {
                box.classList.add('disabled');
            }
        };

        const unlockCells = function() {
            for (box of boxes)
            {
                if (box.textContent === '') {
                    box.classList.remove('disabled');
                }
            }
        };

        const markCell = function() {
            if (!this.classList.contains('disabled')) {
                lockCells();
                const id = this.getAttribute('data-id');
                socket.emit('validate_move', id);
            };
        };

        for (box of boxes)
        {
            box.addEventListener('click', markCell);
        }

    </script>
</body>
</html>
